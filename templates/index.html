<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VLM Slotting Optimizer</title>
  <style>
    /* ===== BASE ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      line-height: 1.5;
      padding: 24px;
    }
    h1 { font-size: 1.6rem; font-weight: 700; }
    h2 { font-size: 1.15rem; font-weight: 600; margin-bottom: 12px; color: #333; }
    h3 { font-size: 0.95rem; font-weight: 600; margin-bottom: 6px; }

    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
    }
    .subtitle { color: #666; font-size: 0.9rem; }

    /* ===== CARDS ===== */
    .card {
      background: white; border-radius: 10px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    /* ===== BUTTONS ===== */
    .btn {
      padding: 10px 20px; border: none; border-radius: 6px;
      font-size: 0.9rem; font-weight: 600; cursor: pointer;
      text-decoration: none; display: inline-block; transition: background 0.15s;
    }
    .btn-primary { background: #4a90d9; color: white; }
    .btn-primary:hover { background: #3a7bc8; }
    .btn-secondary { background: #e8e8e8; color: #333; }
    .btn-secondary:hover { background: #ddd; }
    .btn-success { background: #27ae60; color: white; }
    .btn-success:hover { background: #219a52; }

    /* ===== UPLOAD ===== */
    .upload-area { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .upload-area input[type="file"] {
      flex: 1; min-width: 200px; padding: 8px;
      border: 2px dashed #ccc; border-radius: 6px; background: #fafafa; cursor: pointer;
    }
    .upload-area input[type="file"]:hover { border-color: #4a90d9; background: #f0f6ff; }

    /* ===== CONFIG PANEL =====
       WHY COLLAPSIBLE?
       Config is important but you don't change it every run.
       Hiding it behind a toggle keeps the UI clean by default
       but still one click away.
    */
    .config-toggle {
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 14px; padding: 6px 14px;
      background: #f0f2f5; border: 1px solid #ddd; border-radius: 6px;
      cursor: pointer; font-size: 0.85rem; color: #555; font-weight: 500;
      transition: background 0.15s;
    }
    .config-toggle:hover { background: #e4e7ec; }
    .config-toggle .arrow { transition: transform 0.2s; display: inline-block; }
    .config-toggle.open .arrow { transform: rotate(90deg); }

    .config-panel {
      display: none; margin-top: 12px; padding: 16px;
      background: #f8f9fb; border-radius: 8px; border: 1px solid #e8e8e8;
    }
    .config-panel.open { display: block; }

    .config-group-label {
      font-size: 0.75rem; font-weight: 700; color: #888;
      text-transform: uppercase; letter-spacing: 0.5px;
      margin-top: 12px; margin-bottom: 6px;
    }
    .config-group-label:first-child { margin-top: 0; }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }

    .config-field label {
      display: block; font-size: 0.8rem; color: #555; margin-bottom: 3px;
    }
    .config-field input {
      width: 100%; padding: 7px 10px;
      border: 1px solid #ddd; border-radius: 5px;
      font-size: 0.9rem; background: white;
    }
    .config-field input:focus { outline: none; border-color: #4a90d9; }

    .config-calculated {
      display: block; padding: 7px 10px; width: 100%;
      border: 1px solid #e0e0e0; border-radius: 5px;
      font-size: 0.9rem; font-weight: 600; color: #4a90d9;
      background: #f0f4fa;
    }

    .config-hint {
      margin-top: 10px; font-size: 0.78rem; color: #999;
    }

    /* ===== TRAY CONFIG ADD/REMOVE ===== */
    .tray-config-section {
      margin-bottom: 4px;
    }
    .tray-config-header {
      display: flex; align-items: center; gap: 8px;
    }
    .btn-remove-config {
      background: none; border: 1px solid #ddd; border-radius: 4px;
      color: #999; cursor: pointer; font-size: 1rem; padding: 0 6px;
      line-height: 1.4; transition: all 0.15s;
    }
    .btn-remove-config:hover { color: #e74c3c; border-color: #e74c3c; }
    .btn-add-config {
      margin-top: 8px; padding: 5px 14px; font-size: 0.8rem;
      background: #e8e8e8; border: 1px solid #ccc; border-radius: 5px;
      cursor: pointer; font-weight: 500; color: #555;
    }
    .btn-add-config:hover { background: #ddd; }

    /* ===== FLASH MESSAGES ===== */
    .flash { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 0.9rem; }
    .flash-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .flash-error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

    /* ===== SUMMARY DASHBOARD ===== */
    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px; margin-bottom: 16px;
    }
    .stat-card { background: #f8f9fb; border-radius: 8px; padding: 14px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #4a90d9; }
    .stat-value.golden { color: #f39c12; }
    .stat-value.green  { color: #27ae60; }
    .stat-label { font-size: 0.78rem; color: #888; margin-top: 2px; }

    /* ===== TOWER CARDS ===== */
    .towers-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;
    }
    .tower-card {
      background: #f8f9fb; border-radius: 8px; padding: 14px; border-left: 4px solid #4a90d9;
    }
    .tower-card:nth-child(3n+2) { border-left-color: #27ae60; }
    .tower-card:nth-child(3n+0) { border-left-color: #e67e22; }
    .tower-stat { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 3px 0; }
    .tower-stat span:last-child { font-weight: 600; }

    /* ===== RESULTS TABLE ===== */
    .table-controls { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; align-items: center; }
    .search-box {
      flex: 1; min-width: 200px; padding: 8px 12px;
      border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;
    }
    .search-box:focus { outline: none; border-color: #4a90d9; }
    .filter-select {
      padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;
      font-size: 0.9rem; background: white;
    }
    .table-wrapper {
      overflow-x: auto; max-height: 500px; overflow-y: auto;
      border-radius: 6px; border: 1px solid #e0e0e0;
    }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    thead th {
      background: #f0f2f5; padding: 10px 12px; text-align: left;
      font-weight: 600; color: #555; position: sticky; top: 0; z-index: 1;
      cursor: pointer; user-select: none; white-space: nowrap;
    }
    thead th:hover { background: #e4e7ec; }
    thead th.sorted-asc::after  { content: " \25B2"; font-size: 0.7rem; }
    thead th.sorted-desc::after { content: " \25BC"; font-size: 0.7rem; }
    tbody td { padding: 8px 12px; border-top: 1px solid #f0f0f0; }
    tbody tr:hover { background: #f7f9fc; }

    .zone-golden   { color: #f39c12; font-weight: 600; }
    .zone-standard { color: #888; }
    .picks-high { color: #e74c3c; font-weight: 700; }
    .picks-med  { color: #f39c12; font-weight: 600; }
    .picks-low  { color: #888; }
    .row-count { font-size: 0.8rem; color: #888; margin-top: 8px; }

    .empty-state { text-align: center; padding: 48px 24px; color: #888; }
    .empty-state p { margin-top: 8px; font-size: 0.95rem; }

    .file-badge {
      display: inline-block; background: #e8f4fd; color: #2980b9;
      padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- HEADER -->
    <div class="header">
      <div>
        <h1>VLM Slotting Optimizer</h1>
        <span class="subtitle">
          {{ config.num_towers }}-Tower Vertical Lift Module &mdash;
          Direct Mapping &amp; Golden Zone Optimization
        </span>
      </div>
      {% if rows %}
        <a href="/download" class="btn btn-success">Download Slotting Map (CSV)</a>
      {% endif %}
    </div>

    <!-- FLASH MESSAGES -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
      {% endfor %}
    {% endwith %}

    <!--
      UPLOAD + CONFIG CARD
      WHY ONE FORM FOR BOTH?
        The file and config are submitted together in a single POST.
        This is simpler than having two separate forms or using AJAX.
        When you click "Run Slotting", Flask receives both the CSV file
        and all the config values at once.
    -->
    <div class="card">
      <h2>Upload SKU Data</h2>
      <form action="/run" method="post" enctype="multipart/form-data">
        <div class="upload-area">
          <input type="file" name="file" accept=".csv">
          <button type="submit" class="btn btn-primary">Run Slotting</button>
        </div>
        <p style="margin-top: 8px; font-size: 0.8rem; color: #888;">
          CSV must have columns: SKU, Description, Length_in, Width_in, Height_in, Weight_lbs, Eaches, Weekly_Picks, Tray_Config, Pick_Priority
        </p>

        <!-- CONFIG TOGGLE -->
        <div class="config-toggle" id="configToggle" onclick="toggleConfig()">
          <span class="arrow">&#9654;</span> VLM Configuration
        </div>

        <!-- CONFIG PANEL (hidden by default) -->
        <div class="config-panel" id="configPanel">

          <!-- PRE fields: Machine Layout, Tray Dimensions, Golden Zone -->
          {% set ns = namespace(current_group="") %}
          {% for field in config_fields_pre %}
            {% if field.group != ns.current_group %}
              {% if ns.current_group != "" %}</div>{% endif %}
              <div class="config-group-label">{{ field.group }}</div>
              <div class="config-grid">
              {% set ns.current_group = field.group %}
            {% endif %}
            <div class="config-field">
              <label for="{{ field.key }}">{{ field.label }}</label>
              {% if field.type == 'str' %}
              <input type="text" id="{{ field.key }}" name="{{ field.key }}"
                     value="{{ config[field.key] }}" maxlength="1"
                     style="text-transform: uppercase; width: 60px;">
              {% else %}
              <input type="number" id="{{ field.key }}" name="{{ field.key }}"
                     value="{{ config[field.key] }}"
                     step="{{ '1' if field.type == 'int' else '0.1' }}">
              {% endif %}
            </div>
          {% endfor %}
          {% if config_fields_pre %}</div>{% endif %}

          <!-- DYNAMIC TRAY CONFIGURATIONS (add / remove) -->
          <div id="trayConfigs">
            {% for i in range(1, num_tray_configs + 1) %}
            <div class="tray-config-section" data-config="{{ i }}">
              <div class="config-group-label tray-config-header">
                <span class="config-group-label-text">Tray Config {{ i }}</span>
                <button type="button" class="btn-remove-config" title="Remove this config">&times;</button>
              </div>
              <div class="config-grid">
                <div class="config-field">
                  <label>Cells per Tray</label>
                  <input type="number" data-suffix="cells"
                         name="tray_config_{{ i }}_cells"
                         id="tray_config_{{ i }}_cells"
                         value="{{ config['tray_config_%d_cells' % i] }}" step="1">
                </div>
                <div class="config-field">
                  <label>Tray Height (in)</label>
                  <input type="number" data-suffix="height"
                         name="tray_config_{{ i }}_height"
                         id="tray_config_{{ i }}_height"
                         value="{{ config['tray_config_%d_height' % i] }}" step="0.1">
                </div>
                <div class="config-field">
                  <label>Height Tolerance (%)</label>
                  <input type="number" data-suffix="height_tol"
                         name="tray_config_{{ i }}_height_tol"
                         id="tray_config_{{ i }}_height_tol"
                         value="{{ config['tray_config_%d_height_tol' % i] }}" step="1">
                </div>
                <div class="config-field">
                  <label>Fill Capacity (%)</label>
                  <input type="number" data-suffix="fill_pct"
                         name="tray_config_{{ i }}_fill_pct"
                         id="tray_config_{{ i }}_fill_pct"
                         value="{{ config['tray_config_%d_fill_pct' % i] }}" step="1">
                </div>
                <div class="config-field">
                  <label>Cell Volume (in&sup3;)</label>
                  <span class="config-calculated" data-suffix="cell_vol"
                        id="tray_config_{{ i }}_cell_vol">--</span>
                </div>
                <div class="config-field">
                  <label>Eff. Volume (in&sup3;)</label>
                  <span class="config-calculated" data-suffix="eff_vol"
                        id="tray_config_{{ i }}_eff_vol">--</span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          <button type="button" class="btn-add-config" id="addConfigBtn">+ Add Tray Config</button>
          <input type="hidden" name="num_tray_configs" id="numTrayConfigs" value="{{ num_tray_configs }}">

          <!-- POST fields: Spacing, Algorithm -->
          {% set ns = namespace(current_group="") %}
          {% for field in config_fields_post %}
            {% if field.group != ns.current_group %}
              {% if ns.current_group != "" %}</div>{% endif %}
              <div class="config-group-label">{{ field.group }}</div>
              <div class="config-grid">
              {% set ns.current_group = field.group %}
            {% endif %}
            <div class="config-field">
              <label for="{{ field.key }}">{{ field.label }}</label>
              <input type="number" id="{{ field.key }}" name="{{ field.key }}"
                     value="{{ config[field.key] }}"
                     step="{{ '1' if field.type == 'int' else '0.1' }}">
            </div>
          {% endfor %}
          {% if config_fields_post %}</div>{% endif %}

          <p class="config-hint">
            Changes take effect on the next "Run Slotting". Values are remembered between runs.
          </p>
        </div>
      </form>
    </div>

    {% if summary %}
    <!-- SUMMARY DASHBOARD -->
    <div class="card">
      <h2>
        Slotting Summary
        {% if input_filename %}
          <span class="file-badge">{{ input_filename }}</span>
        {% endif %}
      </h2>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value green">{{ summary.total_placed }}</div>
          <div class="stat-label">SKUs Placed / {{ summary.total_skus }} Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ summary.trays_used }} / {{ summary.trays_total }}</div>
          <div class="stat-label">Trays Used</div>
        </div>
        <div class="stat-card">
          <div class="stat-value golden">{{ summary.golden_pct }}%</div>
          <div class="stat-label">Picks in Golden Zone</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ summary.heaviest_tray }} lbs</div>
          <div class="stat-label">Heaviest Tray (max {{ summary.weight_limit }})</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">{{ summary.avg_tray_weight }} lbs</div>
          <div class="stat-label">Avg Tray Weight</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" style="color: {% if summary.warnings|length > 0 %}#e74c3c{% else %}#27ae60{% endif %}">
            {{ summary.warnings|length }}
          </div>
          <div class="stat-label">Warnings</div>
        </div>
      </div>

      <!-- Tray config usage breakdown -->
      <h3>Tray Configurations Used</h3>
      <div class="stats-grid" style="margin-bottom: 16px;">
        {% for config_name, usage in summary.config_usage.items()|sort %}
        <div class="stat-card">
          <div class="stat-value" style="font-size: 1.2rem;">{{ config_name }}</div>
          <div class="stat-label">{{ usage.trays }} trays &middot; {{ usage['items'] }} items</div>
        </div>
        {% endfor %}
      </div>

      <h3>Tower Breakdown</h3>
      <div class="towers-grid">
        {% for t in summary.towers %}
        <div class="tower-card">
          <h3>Tower {{ t.tower }}</h3>
          <div class="tower-stat"><span>Items</span><span>{{ t.items }}</span></div>
          <div class="tower-stat"><span>Trays used</span><span>{{ t.trays_used }}</span></div>
          <div class="tower-stat"><span>Golden zone</span><span>{{ t.golden_items }}</span></div>
          <div class="tower-stat"><span>Weight</span><span>{{ t.weight }} lbs</span></div>
        </div>
        {% endfor %}
      </div>

      {% if summary.validation_errors %}
      <div style="margin-top: 16px; padding: 12px; background: #f8d7da; border-radius: 6px;">
        <h3 style="color: #721c24;">Validation Errors ({{ summary.validation_errors|length }})</h3>
        <ul style="margin-top: 6px; padding-left: 20px; font-size: 0.85rem;">
          {% for e in summary.validation_errors %}
            <li><strong>{{ e.sku_id }}</strong> [{{ e.check }}]: {{ e.message }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if summary.warnings %}
      <div style="margin-top: 16px; padding: 12px; background: #fff3cd; border-radius: 6px;">
        <h3 style="color: #856404;">Warnings ({{ summary.warnings|length }})</h3>
        <ul style="margin-top: 6px; padding-left: 20px; font-size: 0.85rem;">
          {% for w in summary.warnings %}
            <li>[{{ w.type }}] {{ w.message }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    <!-- RESULTS TABLE -->
    <div class="card">
      <h2>Slotting Map</h2>
      <div class="table-controls">
        <input type="text" class="search-box" id="searchBox"
               placeholder="Search by SKU, description, tower...">
        <select class="filter-select" id="towerFilter">
          <option value="">All Towers</option>
          {% for t in summary.towers %}
            <option value="{{ t.tower }}">Tower {{ t.tower }}</option>
          {% endfor %}
        </select>
        <select class="filter-select" id="configFilter">
          <option value="">All Configs</option>
          {% for config_name in summary.config_usage.keys()|sort %}
            <option value="{{ config_name }}">{{ config_name }}</option>
          {% endfor %}
        </select>
        <select class="filter-select" id="zoneFilter">
          <option value="">All Zones</option>
          <option value="Golden">Golden Zone</option>
          <option value="Standard">Standard</option>
        </select>
      </div>

      <div class="table-wrapper">
        <table id="slottingTable">
          <thead>
            <tr>
              <th data-col="0">Bin Label</th>
              <th data-col="1">SKU</th>
              <th data-col="2">Description</th>
              <th data-col="3">Pick Priority</th>
              <th data-col="4">Tower</th>
              <th data-col="5">Tray</th>
              <th data-col="6">Cell</th>
              <th data-col="7">Config</th>
              <th data-col="8">Picks/Wk</th>
              <th data-col="9">Eaches</th>
              <th data-col="10">Cell Wt</th>
              <th data-col="11">Dims (in)</th>
              <th data-col="12">SKU Vol</th>
              <th data-col="13">Total Vol</th>
              <th data-col="14">Cell Vol</th>
              <th data-col="15">Zone</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            {% for row in rows %}
            <tr data-tower="{{ row.Tower }}" data-zone="{{ row.Tray_Zone }}" data-config="{{ row.Tray_Config }}">
              <td style="font-family: monospace; font-weight: 600;">{{ row.Bin_Label }}</td>
              <td>{{ row.SKU }}</td>
              <td>{{ row.Description }}</td>
              <td>{{ row.Pick_Priority }}</td>
              <td>{{ row.Tower }}</td>
              <td>{{ row.Tray }}</td>
              <td>{{ row.Cell }}</td>
              <td>{{ row.Tray_Config }}</td>
              <td class="{% if row.Weekly_Picks >= 7 %}picks-high{% elif row.Weekly_Picks >= 4 %}picks-med{% else %}picks-low{% endif %}">
                {{ row.Weekly_Picks }}
              </td>
              <td>{{ row.Eaches }}</td>
              <td>{{ row.Cell_Weight_lbs }}</td>
              <td>{{ row.Length_in }}&times;{{ row.Width_in }}&times;{{ row.Height_in }}</td>
              <td>{{ row.SKU_Vol_in3 }}</td>
              <td>{{ row.Total_Vol_in3 }}</td>
              <td>{{ row.Cell_Vol_in3 }}</td>
              <td class="{% if row.Tray_Zone == 'Golden' %}zone-golden{% else %}zone-standard{% endif %}">
                {{ row.Tray_Zone }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="row-count" id="rowCount">Showing {{ rows|length }} of {{ rows|length }} items</div>
    </div>

    {% else %}
    <!-- EMPTY STATE -->
    <div class="card empty-state">
      <h2>No Slotting Results Yet</h2>
      <p>Upload a CSV file with your SKU data and click "Run Slotting" to get started.</p>
      <p style="font-size: 0.85rem; margin-top: 12px;">
        You can use the included <strong>sample_skus.csv</strong> to try it out.
      </p>
    </div>
    {% endif %}

  </div>

  <script>
    // ===== CONFIG PANEL TOGGLE =====
    function toggleConfig() {
      const toggle = document.getElementById("configToggle");
      const panel  = document.getElementById("configPanel");
      toggle.classList.toggle("open");
      panel.classList.toggle("open");
    }

    // ===== LIVE VOLUME CALCULATIONS =====
    // Loops over all tray-config-section elements (dynamic count).
    function updateVolumes() {
      const trayWidth    = parseFloat(document.getElementById("tray_width").value) || 0;
      const trayDepth    = parseFloat(document.getElementById("tray_depth").value) || 0;
      const dividerWidth = parseFloat(document.getElementById("divider_width").value) || 0;

      document.querySelectorAll(".tray-config-section").forEach(section => {
        const i       = section.dataset.config;
        const cells   = parseInt(document.getElementById(`tray_config_${i}_cells`)?.value) || 0;
        const height  = parseFloat(document.getElementById(`tray_config_${i}_height`)?.value) || 0;
        const fillPct = parseInt(document.getElementById(`tray_config_${i}_fill_pct`)?.value) || 0;

        let cellVol = 0, effVol = 0;
        if (cells > 0) {
          const cellWidth = (trayWidth - (cells - 1) * dividerWidth) / cells;
          cellVol = cellWidth * trayDepth * height;
          effVol  = cellVol * fillPct / 100;
        }

        const cellVolEl = document.getElementById(`tray_config_${i}_cell_vol`);
        const effVolEl  = document.getElementById(`tray_config_${i}_eff_vol`);
        if (cellVolEl) cellVolEl.textContent = cellVol > 0 ? cellVol.toFixed(1) : "--";
        if (effVolEl)  effVolEl.textContent  = effVol > 0  ? effVol.toFixed(1)  : "--";
      });
    }

    // Attach volume-update listeners to inputs inside a tray config section
    function attachVolumeListeners(section) {
      section.querySelectorAll('input[data-suffix="cells"], input[data-suffix="height"], input[data-suffix="fill_pct"]')
        .forEach(el => el.addEventListener("input", updateVolumes));
    }

    // ===== ADD TRAY CONFIG =====
    document.getElementById("addConfigBtn").addEventListener("click", function() {
      const container = document.getElementById("trayConfigs");
      const num = container.querySelectorAll(".tray-config-section").length + 1;

      const section = document.createElement("div");
      section.className = "tray-config-section";
      section.dataset.config = num;
      section.innerHTML = `
        <div class="config-group-label tray-config-header">
          <span class="config-group-label-text">Tray Config ${num}</span>
          <button type="button" class="btn-remove-config" title="Remove this config">&times;</button>
        </div>
        <div class="config-grid">
          <div class="config-field">
            <label>Cells per Tray</label>
            <input type="number" data-suffix="cells"
                   name="tray_config_${num}_cells" id="tray_config_${num}_cells"
                   value="6" step="1">
          </div>
          <div class="config-field">
            <label>Tray Height (in)</label>
            <input type="number" data-suffix="height"
                   name="tray_config_${num}_height" id="tray_config_${num}_height"
                   value="12.0" step="0.1">
          </div>
          <div class="config-field">
            <label>Height Tolerance (%)</label>
            <input type="number" data-suffix="height_tol"
                   name="tray_config_${num}_height_tol" id="tray_config_${num}_height_tol"
                   value="10" step="1">
          </div>
          <div class="config-field">
            <label>Fill Capacity (%)</label>
            <input type="number" data-suffix="fill_pct"
                   name="tray_config_${num}_fill_pct" id="tray_config_${num}_fill_pct"
                   value="85" step="1">
          </div>
          <div class="config-field">
            <label>Cell Volume (in&sup3;)</label>
            <span class="config-calculated" data-suffix="cell_vol"
                  id="tray_config_${num}_cell_vol">--</span>
          </div>
          <div class="config-field">
            <label>Eff. Volume (in&sup3;)</label>
            <span class="config-calculated" data-suffix="eff_vol"
                  id="tray_config_${num}_eff_vol">--</span>
          </div>
        </div>`;

      container.appendChild(section);
      document.getElementById("numTrayConfigs").value = num;
      attachVolumeListeners(section);
      updateVolumes();
    });

    // ===== REMOVE TRAY CONFIG (event delegation) =====
    document.getElementById("trayConfigs").addEventListener("click", function(e) {
      if (!e.target.classList.contains("btn-remove-config")) return;
      const sections = document.querySelectorAll(".tray-config-section");
      if (sections.length <= 1) {
        alert("Must have at least one tray configuration.");
        return;
      }
      e.target.closest(".tray-config-section").remove();
      renumberConfigs();
    });

    // After removing a config, renumber all remaining ones (1, 2, 3, ...)
    // so form field names stay sequential.
    function renumberConfigs() {
      document.querySelectorAll(".tray-config-section").forEach((section, idx) => {
        const num = idx + 1;
        section.dataset.config = num;
        section.querySelector(".config-group-label-text").textContent = `Tray Config ${num}`;

        // Update input names and IDs
        section.querySelectorAll("input[data-suffix]").forEach(input => {
          const suffix = input.dataset.suffix;
          input.name = `tray_config_${num}_${suffix}`;
          input.id   = `tray_config_${num}_${suffix}`;
        });

        // Update calculated span IDs
        section.querySelectorAll(".config-calculated[data-suffix]").forEach(span => {
          const suffix = span.dataset.suffix;
          span.id = `tray_config_${num}_${suffix}`;
        });
      });

      document.getElementById("numTrayConfigs").value =
        document.querySelectorAll(".tray-config-section").length;
      updateVolumes();
    }

    // ===== INIT: attach listeners to existing sections + global fields =====
    document.querySelectorAll(".tray-config-section").forEach(attachVolumeListeners);
    ["tray_width", "tray_depth", "divider_width"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", updateVolumes);
    });
    updateVolumes();

    {% if rows %}
    // ===== SEARCH & FILTER =====
    const searchBox    = document.getElementById("searchBox");
    const towerFilter  = document.getElementById("towerFilter");
    const configFilter = document.getElementById("configFilter");
    const zoneFilter   = document.getElementById("zoneFilter");
    const tableBody    = document.getElementById("tableBody");
    const rowCount     = document.getElementById("rowCount");
    const allRows      = Array.from(tableBody.querySelectorAll("tr"));
    const totalCount   = allRows.length;

    function applyFilters() {
      const query  = searchBox.value.toLowerCase();
      const tower  = towerFilter.value;
      const config = configFilter.value;
      const zone   = zoneFilter.value;
      let visible = 0;

      allRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const matchesSearch = !query  || text.includes(query);
        const matchesTower  = !tower  || row.dataset.tower === tower;
        const matchesConfig = !config || row.dataset.config === config;
        const matchesZone   = !zone   || row.dataset.zone === zone;
        const show = matchesSearch && matchesTower && matchesConfig && matchesZone;
        row.style.display = show ? "" : "none";
        if (show) visible++;
      });

      rowCount.textContent = `Showing ${visible} of ${totalCount} items`;
    }

    searchBox.addEventListener("input", applyFilters);
    towerFilter.addEventListener("change", applyFilters);
    configFilter.addEventListener("change", applyFilters);
    zoneFilter.addEventListener("change", applyFilters);

    // ===== COLUMN SORTING =====
    const headers = document.querySelectorAll("#slottingTable thead th");
    let currentSort = { col: -1, asc: true };

    headers.forEach(th => {
      th.addEventListener("click", () => {
        const col = parseInt(th.dataset.col);
        const asc = (currentSort.col === col) ? !currentSort.asc : true;
        currentSort = { col, asc };

        headers.forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));
        th.classList.add(asc ? "sorted-asc" : "sorted-desc");

        allRows.sort((a, b) => {
          let va = a.children[col].textContent.trim();
          let vb = b.children[col].textContent.trim();
          const na = parseFloat(va), nb = parseFloat(vb);
          if (!isNaN(na) && !isNaN(nb)) return asc ? na - nb : nb - na;
          return asc ? va.localeCompare(vb) : vb.localeCompare(va);
        });

        allRows.forEach(row => tableBody.appendChild(row));
      });
    });
    {% endif %}
  </script>
</body>
</html>
